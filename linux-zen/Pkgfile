# Description:  Zen Patched Kernel
# URL:          https://github.com/zen-kernel/zen-kernel
# Maintainer:   Alexandr Savca, drop at chinarulezzz dot fun

name=linux-zen
version=5.8.3.1
release=3
source=(https://github.com/zen-kernel/zen-kernel/archive/v${version%.*}-zen${version##*.}/$name-${version%.*}-zen${version##*.}.tar.gz)

build() {
	cd "zen-kernel-${version%.*}-zen${version##*.}"

	if [ -f $PKGMK_ROOT/config ]]; then
		cp $PKGMK_ROOT/config .config
	else
		cp $PKGMK_ROOT/defconfig .config
	fi

	mkdir firmware
	shopt -s nullglob
	for fw in $PKGMK_ROOT/*.ucode; do
		cp $fw firmware
	done

	# remove extraversion
	sed -Ei 's|(EXTRAVERSION =).*|\1|' Makefile

	# compile with Ofast
	grep -Rm1 -- '-O3' | cut -d : -f1 | xargs sed -i 's/-O3/-Ofast/g'

	make olddefconfig
	make all

	grep -q 'CONFIG_MODULES=y' .config && make INSTALL_MOD_PATH=$PKG modules_install

	install -Dm644 System.map $PKG/boot/System.map-$version
	install -Dm644 arch/x86_64/boot/bzImage $PKG/boot/vmlinuz-$version
}
