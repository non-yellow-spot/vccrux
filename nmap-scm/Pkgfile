# Description: Network exploration of security auditing + extra scripts
# URL:         https://nmap.org
# Maintainer:  Alexandr Savca, alexandrsavca89 at gmail dot com
# Depends on:  git libpcap pango-compat python pygtk

name=nmap-scm
version=$(date +%Y%m%d)
release=2
source=(DiffCompare.patch
	NmapOutputViewer.patch)

download_git() {
	if [[ -d $PKGMK_SOURCE_DIR/$3 ]]; then
		git -C $PKGMK_SOURCE_DIR/$3 fetch --depth=1
		git -C $PKGMK_SOURCE_DIR/$3 clean -f
		git -C $PKGMK_SOURCE_DIR/$3 reset --hard origin/$2
	else
		git -C $PKGMK_SOURCE_DIR clone --depth=1 $1 -b $2 $3
	fi

	cp -r $PKGMK_SOURCE_DIR/$3 $PKGMK_WORK_DIR/src/$3
}

build() {
	download_git https://github.com/${name/-scm}/${name/-scm} \
		master $name
	download_git https://github.com/chinarulezzz/nmap-extra-scripts \
		master nmap-extra-scripts-scm

	cd $name

	# Zenmap fix: Respect system font settings
	patch ./zenmap/zenmapGUI/DiffCompare.py      $SRC/DiffCompare.patch
	patch ./zenmap/zenmapGUI/NmapOutputViewer.py $SRC/NmapOutputViewer.patch

	./configure \
		--prefix=/usr \
		--libexecdir=/usr/lib \
		--with-liblua=included \
		--with-libpcre=included \
		--without-nmap-update \
		--disable-nls

	make
	make DESTDIR=$PKG install

	# Remove junk
	rm -f  $PKG/usr/share/nmap/nselib/data/psexec/README
	rm -f  $PKG/usr/share/nmap/nselib/data/jdwp-class/README.txt
	rm -rf $PKG/usr/share/zenmap/locale
	rm -f  $PKG/usr/bin/uninstall_zenmap
	rm -f  $PKG/usr/bin/uninstall_ndiff
	rm -rf $PKG/usr/share/zenmap/docs

	# Prepare extra scripts
	(cd $PKGMK_SOURCE_DIR/nmap-extra-scripts-scm
	for nse in *.nse; do
		install -Dm644 $nse $PKG/usr/share/nmap/scripts/${nse#*-}
	done
	/bin/sh ./update-scriptdb.sh $PKG/usr/share/nmap/scripts/script.db)

	# Fix "PangoFc will not work correctly"
	mkdir -p $PKG/usr/etc/pango
	pango-querymodules > $PKG/usr/etc/pango/pango.modules
}
