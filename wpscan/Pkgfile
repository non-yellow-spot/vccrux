# Description:  Black box WordPress vulnerability scanner
# URL:          https://wpscan.org
# Maintainer:   Alexandr Savca, drop at chinarulezzz dot fun
# Depends on:   ruby libxslt libyaml curl libxml2

name=wpscan
version=3.8.7
release=1
source=(https://github.com/wpscanteam/wpscan/archive/v$version/$name-$version.tar.gz)

build() {
	cd $name-$version

	sed -i '/bundler/ s|~>|>=|g' $name.gemspec
	bundle config build.nokogiri --use-system-libraries
	bundle config set --local path vendor/bundle
	bundle config set --local without development test
	bundle config set deployment 'false'
	bundle config set no-cache 'true'
	sed 's|git ls-files|find -type f|' -i $name.gemspec

	CFLAGS+=" -I/usr/include/libxml2"

	bundle install -j${JOBS}

	# reproducible builds: don't leak jobs count
	sed '/BUNDLE_JOBS/d' -i .bundle/config

	install -d $PKG/opt/$name
	cp -ra --no-preserve=owner . $PKG/opt/$name

	install -d $PKG/usr/bin
	cat > $PKG/usr/bin/$name << EOF
#!/bin/sh
BUNDLE_GEMFILE=/opt/$name/Gemfile bundle exec ruby /opt/wpscan/bin/wpscan "\$@"
EOF
	chmod 755 $PKG/usr/bin/$name

	find $PKG \( \
		-name gem_make.out -or \
		-name mkmf.log -or \
		-name README* -or \
		-name README -or \
		-name ChangeLog.* -or \
		-name COPYING \
	\) -delete
	rm -r $PKG/opt/wpscan/vendor/bundle/ruby/*/cache
	find $PKG -depth -type d -empty -delete
}
